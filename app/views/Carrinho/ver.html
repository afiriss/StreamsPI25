#{extends 'main.html' /}
#{set title:'Carrinho de Compras' /}

<div class="container">
    <h1>Seu Carrinho</h1>

    #{if itens.isEmpty()}
        <p>Seu carrinho está vazio.</p>
    #{/if}
    #{else}
        <table class="table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Preço</th>
                    <th>Quantidade</th>
                    <th>Subtotal</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                #{list items:itens, as:'item'}
                    <tr>
                        <td>${item.filme.nome}</td>
                        <td>R$ ${item.filme.preco}</td>
                        <td>${item.quantidade}</td>
                        <td>R$ ${item.getSubtotal()}</td>
                        <td><a href="@{Carrinho.remover(item.id)}" class="btn btn-danger btn-sm btn-remover-item">Remover</a></td>
                    </tr>
                #{/list}
            </tbody>
        </table>

        <h3>Total: R$ ${total}</h3>

        <div>
            <a href="@{Carrinho.limpar()}" id="btn-limpar" class="btn btn-warning" >Limpar Carrinho</a>
            <a href="@{Pedidos.finalizar()}" class="btn btn-success">Finalizar Compra</a>
        </div>
    #{/else}
    <div>
         <a href="@{Filmes.listar()}" class="btn btn-secondary">Continuar Comprando</a>
    </div>
</div>

#{set 'moreScripts'}
    <script src="@{'/public/javascripts/jquery-1.6.4.min.js'}"></script>
<script type="text/javascript">
    $(document).ready(function() {

        // Função visual para carrinho vazio
        function mostrarVazio() {
            $('table.table, h3, .btn-warning, .btn-success').fadeOut();
            if ($('.alert-info').length === 0) {
                $('.container h1').after('<p class="alert alert-info mt-3">Seu carrinho está vazio.</p>');
            }
            $('#contador-carrinho').text("");
        }

        // AÇÃO: Remover/Decrementar
        $('.btn-remover-item').unbind('click').click(function(e) {
            e.preventDefault();
            var botao = $(this);
            var linha = botao.closest('tr');
            
            // Células para atualizar
            var celulaQtd = linha.find('td').eq(2);
            var celulaSub = linha.find('td').eq(3);
            var tituloTotal = $('h3'); // Onde mostra o total R$

            $.ajax({
                url: botao.attr('href'),
                type: 'POST',
                dataType: 'json',
                success: function(data) {
                    // 1. Atualiza contador do menu
                    var count = data.totalItens > 0 ? data.totalItens : "";
                    $('#contador-carrinho').text(count);

                    // 2. Atualiza valor total da compra
                    tituloTotal.text('Total: R$ ' + data.valorTotalCompra.toFixed(2).replace('.', ','));

                    if (data.removido) {
                        // Se removeu a linha inteira
                        linha.fadeOut(300, function() {
                            $(this).remove();
                            if ($('table tbody tr').length === 0) mostrarVazio();
                        });
                    } else {
                        // Se só diminuiu a quantidade
                        celulaQtd.text(data.novaQtd);
                        celulaSub.text('R$ ' + data.novoSubtotal.toFixed(2).replace('.', ','));
                    }
                }
            });
        });

        // AÇÃO: Limpar tudo (mantido simples)
        $('#btn-limpar').click(function(e) {
            e.preventDefault();
            if(!confirm("Esvaziar carrinho?")) return;
            
            $.ajax({
                url: $(this).attr('href'),
                success: function() {
                    mostrarVazio();
                }
            });
        });
    });
</script>
    
#{/set}