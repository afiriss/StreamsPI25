#{extends 'main.html' /}
#{set title:'Carrinho de Compras' /}

<div class="container">
    <h1>Seu Carrinho</h1>

    #{if itens.isEmpty()}
        <p>Seu carrinho está vazio.</p>
    #{/if}
    #{else}
        <table class="table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Preço</th>
                    <th>Quantidade</th>
                    <th>Subtotal</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                #{list items:itens, as:'item'}
                    <tr>
                        <td>${item.filme.nome}</td>
                        <td>R$ ${item.filme.preco}</td>
                        <td>${item.quantidade}</td>
                        <td>R$ ${item.getSubtotal()}</td>
                        <td><a href="@{Carrinho.remover(item.id)}" class="btn btn-danger btn-sm btn-remover-item">Remover</a></td>
                    </tr>
                #{/list}
            </tbody>
        </table>

        <h3>Total: R$ ${total}</h3>

        <div>
            <a href="@{Carrinho.limpar()}" id="btn-limpar" class="btn btn-warning" >Limpar Carrinho</a>
            <a href="@{Pedidos.finalizar()}" class="btn btn-success">Finalizar Compra</a>
        </div>
    #{/else}
    <div>
         <a href="@{Filmes.listar()}" class="btn btn-secondary">Continuar Comprando</a>
    </div>
</div>

#{set 'moreScripts'}
    <script src="@{'/public/javascripts/jquery-1.6.4.min.js'}"></script>

    <script type="text/javascript">
        $(document).ready(function() {

            // --- FUNÇÃO AUXILIAR: Transição para Carrinho Vazio ---
            // Chamada quando limpamos tudo ou removemos o último item
            function mostrarCarrinhoVazio() {
                // Esconde a tabela, o total e os botões de ação
                $('table.table, h3, .btn-warning, .btn-success').fadeOut(300, function() {
                    $(this).remove();
                });

                // Verifica se a mensagem já existe para não duplicar
                if ($('.alert-info').length === 0) {
                    $('.container h1').after('<p class="alert alert-info mt-3">Seu carrinho está vazio.</p>');
                }
            }

            // --- AÇÃO 1: Remover Item Específico ---
            $('.btn-remover-item').live('click', function(e) {
                e.preventDefault();
                
                var botao = $(this);
                var url = botao.attr('href');
                var linha = botao.closest('tr');

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function() {
                        linha.fadeOut(300, function() {
                            $(this).remove();
                            
                            // Verifica quantos itens sobraram
                            // Se não houver mais linhas no corpo da tabela, mostra "Vazio"
                            if ($('table tbody tr').length === 0) {
                                mostrarCarrinhoVazio();
                            }
                        });
                    },
                    error: function() {
                        alert("Erro ao remover o item. Tente recarregar a página.");
                    }
                });
            });

            // --- AÇÃO 2: Limpar Todo o Carrinho ---
            $('#btn-limpar').click(function(e) {
                e.preventDefault();

                if (!confirm("Tem certeza que deseja esvaziar todo o carrinho?")) {
                    return;
                }

                var url = $(this).attr('href');

                $.ajax({
                    url: url,
                    type: 'GET',
                    success: function() {
                        // Chama a mesma função auxiliar para esconder tudo
                        mostrarCarrinhoVazio();
                    },
                    error: function() {
                        alert("Erro ao limpar o carrinho.");
                    }
                });
            });

        });
    </script>
#{/set}