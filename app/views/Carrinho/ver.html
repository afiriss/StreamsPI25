#{extends 'main.html' /}
#{set title:'Carrinho de Compras' /}

<div class="container">
    <h1>Seu Carrinho</h1>

    #{if itens.isEmpty()}
        <p>Seu carrinho está vazio.</p>
    #{/if}
    #{else}
        <table class="table">
            <thead>
                <tr>
                    <th>Produto</th>
                    <th>Preço</th>
                    <th>Quantidade</th>
                    <th>Subtotal</th>
                    <th>Ação</th>
                </tr>
            </thead>
            <tbody>
                #{list items:itens, as:'item'}
                    <tr>
                        <td>${item.filme.nome}</td>
                        <td>R$ ${item.filme.preco}</td>
                        <td>${item.quantidade}</td>
                        <td>R$ ${item.getSubtotal()}</td>
                        <td><a href="@{Carrinho.remover(item.id)}" class="btn btn-danger btn-sm">Remover</a></td>
                    </tr>
                #{/list}
            </tbody>
        </table>

        <h3>Total: R$ ${total}</h3>

        <div>
            <a href="@{Carrinho.limpar()}" id="btn-limpar" class="btn btn-warning" >Limpar Carrinho</a>
            <a href="@{Pedidos.finalizar()}" class="btn btn-success">Finalizar Compra</a>
        </div>
    #{/else}
    <div>
         <a href="@{Filmes.listar()}" class="btn btn-secondary">Continuar Comprando</a>
    </div>
</div>

#{set 'moreScripts'}
    <script src="@{'/public/javascripts/jquery-1.6.4.min.js'}"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            
            $('#btn-limpar').click(function(e) {
                e.preventDefault(); // 1. Impede o recarregamento da página

                if(!confirm("Tem certeza que deseja remover todos os itens?")) {
                    return;
                }

                var url = $(this).attr('href');
                
                // 2. Requisição AJAX
                $.ajax({
                    url: url,
                    success: function(resposta) {
                        // 3. Atualiza a interface visualmente
                        
                        // Remove a tabela de produtos
                        $('table.table').fadeOut(300, function(){ $(this).remove(); });
                        
                        // Remove o total (h3) e a div que contém os botões de ação
                        $('h3').fadeOut(300, function(){ $(this).remove(); });
                        $('#btn-limpar').parent().fadeOut(300, function(){ $(this).remove(); });

                        // Insere a mensagem de "Carrinho vazio" logo após o título h1
                        $('.container h1').after('<p class="alert alert-info mt-3">Seu carrinho está vazio.</p>');

                        // Feedback opcional
                        // alert(resposta); 
                    },
                    error: function() {
                        alert("Erro ao limpar o carrinho.");
                    }
                });
            });
        });
    </script>
#{/set}